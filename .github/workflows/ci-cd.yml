name: CI/CD Pipeline
on:
  push:
    branches: [ main, design ]
  pull_request:
    branches: [ main, design ]
  schedule:
    - cron: '0 3 * * 1' # Every Monday at 03:00 UTC
jobs:
  security-scan:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Python dependency scan (pip-audit)
        run: |
          cd backend
          pip install pip-audit
          pip-audit
      - name: Node.js dependency scan (npm audit)
        run: |
          cd frontend
          npm audit --audit-level=moderate || true
                cd frontend
                npm audit --audit-level=moderate || true
            - name: Node.js dependency scan (npm audit e2e)
              run: |
                cd e2e
                npm audit --audit-level=moderate || true
            - name: Docker image scan (Trivy)
              uses: aquasecurity/trivy-action@master
              with:
                image-ref: 'anantam-backend:latest'
              continue-on-error: true
            - name: Docker image scan (Trivy frontend)
              uses: aquasecurity/trivy-action@master
              with:
                image-ref: 'anantam-frontend:latest'
              continue-on-error: true
        test-backend:
          runs-on: ubuntu-latest
          needs: setup
          services:
            postgres:
              image: postgres:15
              env:
                POSTGRES_DB: test_db
              ports:
                - 5432:5432
              options: >
                --health-cmd pg_isready
                --health-interval 10s
                --health-timeout 5s
                --health-retries 5
          env:
            DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db  # pragma: allowlist secret
          steps:
            - name: Checkout code
              uses: actions/checkout@v4
                  ./backend/.venv/bin/python scripts/test_with_services.py --ci --no-teardown --no-frontend --no-e2e
                else
                  ./backend/.venv/bin/python scripts/test_with_services.py --ci
                fi
            - name: Upload all test reports
              uses: actions/upload-artifact@v4
              with:
                name: all-test-reports
                path: reports/
                if-no-files-found: ignore
            - name: Summarize test results
              run: |
                echo "::notice file=reports/backend-junit.xml::Backend JUnit XML"
                echo "::notice file=reports/frontend-junit.xml::Frontend JUnit XML"
                echo "::notice file=reports/e2e-junit.xml::E2E JUnit XML"
            - name: Check for flaky tests
              run: |
                python3 scripts/check_flaky_tests.py || echo "FLAKY_TESTS_DETECTED=1" >> $GITHUB_ENV
            - name: Notify on Slack (flaky tests)
              if: env.FLAKY_TESTS_DETECTED == '1'
              uses: 8398a7/action-slack@v3
              with:
                status: custom
                fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
                text: ':warning: Flaky tests detected in recent runs! Please review the test reports.'
              env:
                SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
            - name: Notify on Slack (test-all)
              if: always()
              uses: 8398a7/action-slack@v3
              with:
                status: ${{ job.status }}
                fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
              env:
                SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
                python-version: ${{ matrix.python-version }}
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version: ${{ matrix.node-version }}
            - name: Cache pip
              uses: actions/cache@v4
              with:
                path: ~/.cache/pip
                key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
            - name: Cache npm
              uses: actions/cache@v4
              with:
                path: ~/.npm
                key: ${{ runner.os }}-npm-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json', '**/package.json') }}
            - name: Install backend dependencies
              run: |
                cd backend
                pip install -r requirements.txt
            - name: Install frontend dependencies
              run: |
                cd frontend
                npm ci
            - name: Install e2e dependencies
              run: |
                cd e2e
                npm ci

        lint:
          runs-on: ubuntu-latest
          needs: setup
          steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Lint backend (flake8)
              run: |
                cd backend
                pip install flake8
                flake8 .
            - name: Lint frontend (eslint)
              run: |
                cd frontend
                npm install eslint
                npx eslint src --ext .js,.jsx
            - name: Lint e2e (eslint)
              run: |
                cd e2e
                npm install eslint
                npx eslint tests --ext .js,.ts
            - name: Auto-format backend (black)
              run: |
                cd backend
                pip install black
                black --check .
            - name: Auto-format frontend (prettier)
              run: |
                cd frontend
                npm install prettier
                npx prettier --check "src/**/*.{js,jsx,ts,tsx,json,css,md}"
            - name: Auto-format e2e (prettier)
              run: |
                cd e2e
                npm install prettier
                npx prettier --check "tests/**/*.{js,ts,json,md}"
      - name: Docker image scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'anantam-backend:latest'
        continue-on-error: true
      - name: Docker image scan (Trivy frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'anantam-frontend:latest'
        continue-on-error: true

  test-backend:
    runs-on: ubuntu-latest
    needs: setup
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres  # pragma: allowlist secret
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db  # pragma: allowlist secret
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      - name: Run backend tests with coverage
        run: |
          cd backend
          pip install pytest-cov
          pytest --cov=.
      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # pragma: allowlist secret
          files: backend/coverage.xml
          flags: backend
          name: codecov-backend
      - name: Upload backend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: backend/htmlcov
          if-no-files-found: ignore
      - name: Run backend tests
        run: |
          cd backend
          pytest

  test-frontend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      - name: Run frontend tests with coverage
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false
      - name: Upload frontend coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: frontend/coverage/lcov.info
          flags: frontend
          name: codecov-frontend
      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage
          if-no-files-found: ignore
# Scheduled security scan (runs weekly)
  scheduled-security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Python dependency scan (pip-audit)
        run: |
          cd backend
          pip install pip-audit
          pip-audit
      - name: Node.js dependency scan (npm audit)
        run: |
          cd frontend
          npm audit --audit-level=moderate || true
      - name: Node.js dependency scan (npm audit e2e)
        run: |
          cd e2e
          npm audit --audit-level=moderate || true
      - name: Docker image scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'anantam-backend:latest'
        continue-on-error: true
      - name: Docker image scan (Trivy frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'anantam-frontend:latest'
        continue-on-error: true

  test-e2e:
    runs-on: ubuntu-latest
    needs: [setup, test-backend, test-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install e2e dependencies
        run: |
          cd e2e
          npm ci
      - name: Install Playwright Browsers
        run: |
          cd e2e
          npx playwright install --with-deps
      - name: Run E2E tests
        run: |
          cd e2e
          npx playwright test

  build-docker:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-e2e]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Get short SHA and branch
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
      - name: Build backend Docker image
        run: |
          cd backend
          docker build -t anantam-backend:latest -t anantam-backend:${{ steps.vars.outputs.sha_short }} -t anantam-backend:${{ steps.vars.outputs.branch }} .
      - name: Build frontend Docker image
        run: |
          cd frontend
          docker build -t anantam-frontend:latest -t anantam-frontend:${{ steps.vars.outputs.sha_short }} -t anantam-frontend:${{ steps.vars.outputs.branch }} .

  # Upload test and coverage reports as artifacts
  upload-artifacts:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-e2e]
    steps:
      - name: Upload backend test results
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/.pytest_cache
          if-no-files-found: ignore
      - name: Upload frontend test results
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: frontend/test-results
          if-no-files-found: ignore
      - name: Upload e2e test results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: e2e/test-results
          if-no-files-found: ignore

  deploy:
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Push backend images (all tags)
        run: |
          docker tag anantam-backend:latest ${{ secrets.DOCKERHUB_USERNAME }}/anantam-backend:latest
          docker tag anantam-backend:${{ steps.vars.outputs.sha_short }} ${{ secrets.DOCKERHUB_USERNAME }}/anantam-backend:${{ steps.vars.outputs.sha_short }}
          docker tag anantam-backend:${{ steps.vars.outputs.branch }} ${{ secrets.DOCKERHUB_USERNAME }}/anantam-backend:${{ steps.vars.outputs.branch }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/anantam-backend:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/anantam-backend:${{ steps.vars.outputs.sha_short }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/anantam-backend:${{ steps.vars.outputs.branch }}
      - name: Push frontend images (all tags)
        run: |
          docker tag anantam-frontend:latest ${{ secrets.DOCKERHUB_USERNAME }}/anantam-frontend:latest
          docker tag anantam-frontend:${{ steps.vars.outputs.sha_short }} ${{ secrets.DOCKERHUB_USERNAME }}/anantam-frontend:${{ steps.vars.outputs.sha_short }}
          docker tag anantam-frontend:${{ steps.vars.outputs.branch }} ${{ secrets.DOCKERHUB_USERNAME }}/anantam-frontend:${{ steps.vars.outputs.branch }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/anantam-frontend:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/anantam-frontend:${{ steps.vars.outputs.sha_short }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/anantam-frontend:${{ steps.vars.outputs.branch }}

  notify:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-e2e, build-docker, deploy]
    if: always()
    steps:
      - name: Notify on Slack (success)
        if: ${{ success() }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      - name: Notify on Slack (failure)
        if: ${{ failure() }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
